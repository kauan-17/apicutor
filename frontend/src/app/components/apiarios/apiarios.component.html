<div class="container py-4 apiario-page">
  <div class="header d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="mb-1">{{ apiario?.nome || 'Apiários' }} <span *ngIf="selectedId">#{{ selectedId }}</span></h2>
      <p class="text-muted mb-0" *ngIf="apiario">
        {{ apiario.localizacao || 'Localização não informada' }}
      </p>
    </div>
    <div class="actions">
      <a routerLink="/dashboard" class="btn btn-outline-secondary me-2">Voltar ao Dashboard</a>
      <a *ngIf="!selectedId" routerLink="/apiarios/novo" class="btn btn-success me-2">Novo Apiário</a>
      <a *ngIf="selectedId" routerLink="/apiarios" class="btn btn-primary me-2">Escolher Outro Apiário</a>
      <a class="btn btn-warning me-2" *ngIf="selectedId" [routerLink]="['/apiarios', selectedId, 'editar']">Editar</a>
      <a class="btn btn-primary" *ngIf="selectedId" [routerLink]="['/apiarios', selectedId, 'inspecao', 'nova']">Nova Inspeção</a>
    </div>
  </div>

  <!-- Seleção de Apiário quando nenhum está selecionado -->
  <div *ngIf="!selectedId" class="card mb-4">
    <div class="card-header">Escolha um Apiário</div>
    <div class="card-body">
      <div class="list-group">
        <a class="list-group-item list-group-item-action"
           *ngFor="let a of apiariosLista"
           [routerLink]="['/apiarios', a.id]">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>{{ a.nome }}</strong>
              <div class="small text-muted">{{ a.localizacao || 'Localização não informada' }}</div>
            </div>
            <span class="badge bg-secondary">{{ a.totalColmeias }} colmeias</span>
          </div>
        </a>
        <div *ngIf="!apiariosLista?.length" class="text-muted">Nenhum apiário disponível.</div>
      </div>
    </div>
  </div>

  <div *ngIf="feedbackMessage" class="alert alert-success" role="alert">{{ feedbackMessage }}</div>

  <div class="row g-3 mb-4" *ngIf="selectedId">
    <div class="col-md-3">
      <div class="card stat">
        <div class="card-body">
          <div class="label">Colmeias</div>
          <div class="value">{{ apiario?.totalColmeias || colmeias.length }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card stat">
        <div class="card-body">
          <div class="label">Ativas</div>
          <div class="value">{{ apiario?.colmeiasAtivas }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card stat">
        <div class="card-body">
          <div class="label">Inativas</div>
          <div class="value">{{ apiario?.colmeiasInativas }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3" *ngIf="resumo">
      <div class="card stat">
        <div class="card-body">
          <div class="label">Mês (kg)</div>
          <div class="value">{{ resumo.mesAtualKg }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4" *ngIf="selectedId">
    <div class="col-lg-8">
      <div class="card mb-4">
        <div class="card-header">Colmeias</div>
        <div class="card-body p-0">
          <table class="table mb-0">
            <thead>
              <tr>
                <th>Código</th>
                <th>Rainha</th>
                <th>Força</th>
                <th>Status</th>
                <th>Último mês (kg)</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let c of colmeias">
                <td>{{ c.codigo }}</td>
                <td>{{ c.rainhaIdentificada ? 'Identificada' : 'N/D' }}</td>
                <td>{{ c.forca }}</td>
                <td>{{ c.status }}</td>
                <td>{{ c.producaoUltimoMesKg || 0 }}</td>
              </tr>
              <tr *ngIf="!colmeias?.length">
                <td colspan="5" class="text-center text-muted py-3">Nenhuma colmeia registrada.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card mb-4" *ngIf="inspecoes?.length">
        <div class="card-header">Inspeções Recentes</div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            <li class="list-group-item" *ngFor="let i of inspecoes">
              <strong>{{ i.responsavel }}</strong> — {{ i.data | date:'shortDate' }}
              <div class="small text-muted">Colmeias verificadas: {{ i.colmeiasVerificadas }}</div>
              <div class="small">{{ i.observacoes }}</div>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card mb-4" *ngIf="resumo">
        <div class="card-header">Resumo de Produção</div>
        <div class="card-body">
          <div class="d-flex justify-content-between"><span>Ano (kg)</span><strong>{{ resumo.anoAtualKg }}</strong></div>
          <div class="d-flex justify-content-between"><span>Mês (kg)</span><strong>{{ resumo.mesAtualKg }}</strong></div>
          <div class="d-flex justify-content-between"><span>Média por colmeia</span><strong>{{ resumo.mediaKgPorColmeia }}</strong></div>
          <div class="d-flex justify-content-between"><span>Melhor mês</span><strong>{{ resumo.melhorMes }}</strong></div>
        </div>
      </div>

      <div class="card mb-4" *ngIf="clima">
        <div class="card-header">Clima</div>
        <div class="card-body d-flex align-items-center gap-3">
          <div class="temp">{{ clima.temperaturaC }}°C</div>
          <div>
            <div>{{ clima.condicao }}</div>
            <div class="text-muted small">Umidade: {{ clima.umidade }}%</div>
          </div>
        </div>
      </div>

      <div class="card mb-4" *ngIf="tarefas?.length">
        <div class="card-header">Tarefas</div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            <li class="list-group-item" *ngFor="let t of tarefas">
              {{ t.titulo }}
              <div class="small text-muted" *ngIf="t.prazo">Prazo: {{ t.prazo | date:'shortDate' }}</div>
              <span class="badge bg-secondary">{{ t.status }}</span>
            </li>
          </ul>
        </div>
      </div>

      <div class="card" *ngIf="alertas?.length">
        <div class="card-header">Alertas</div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            <li class="list-group-item d-flex justify-content-between align-items-center" *ngFor="let a of alertas">
              <div>
                <strong>{{ a.tipo }}</strong>
                <div class="small">{{ a.mensagem }}</div>
              </div>
              <span class="badge" [ngClass]="{
                'bg-info': a.nivel === 'Info',
                'bg-warning': a.nivel === 'Atenção',
                'bg-danger': a.nivel === 'Crítico'
              }">{{ a.nivel }}</span>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="card mt-3" *ngIf="selectedId">
    <div class="card-header">Localização</div>
    <div class="card-body">
      <div class="map-placeholder">Mapa do apiário (em breve)</div>
      <div class="small text-muted mt-2" *ngIf="apiario">Lat: {{ apiario.latitude }} / Lng: {{ apiario.longitude }}</div>
    </div>
  </div>
</div>